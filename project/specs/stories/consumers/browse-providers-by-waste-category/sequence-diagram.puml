@startuml get-merchants-by-category
title Get Merchants by Category (Story 001)

actor Consumer
participant "SvelteKit\nFrontend" as UI
participant "SvelteKit\nBFF" as BFF
participant "Merchants\nService" as MerchantSvc
database "DynamoDB\nMerchants Table" as DB

== Get Merchants Flow (Home Page → Listings Page) ==

Consumer -> UI: Select category & distance\n(e.g., "Repair Shop", "Within 5km")
activate UI

UI -> UI: Get user location\n(address or geolocation)\nStore: userLat, userLng

UI -> BFF: GET /api/merchants\n?category=Repair
activate BFF
note right: Query params:\n- category (required)\n\nNo location or radius passed!\nBackend returns ALL merchants

BFF -> BFF: Validate category param
BFF -> BFF: Sanitize input

BFF -> MerchantSvc: GET /merchants\n?category=Repair
activate MerchantSvc
note right: Simple query:\nJust category filter

MerchantSvc -> DB: Query GSI1\nGSI1PK = "Repair"
activate DB
note right: DynamoDB Query:\nIndexName: GSI1\nKeyConditionExpression:\n  GSI1PK = :category

DB --> MerchantSvc: All merchants\nin "Repair" category
deactivate DB

MerchantSvc -> MerchantSvc: Transform to API format
MerchantSvc --> BFF: 200 OK\n[{merchantId, name, category,\nlat, lng, rating, ...}]
deactivate MerchantSvc

BFF --> UI: 200 OK\n{merchants: [...], count: N}
deactivate BFF
note left: ALL merchants in category\n(unfiltered, unsorted)

UI -> UI: Calculate distances\nusing Haversine formula\n(userLat/Lng → merchant lat/lng)
UI -> UI: Filter by radius (5km)
UI -> UI: Sort by distance
UI -> UI: Render list view
UI -> UI: Render map view\nwith markers

UI --> Consumer: Display results\n(list + map)
deactivate UI

== Client-Side Filtering (Listings Page) ==

note over Consumer, UI
  All subsequent filtering happens client-side:
  - Additional category filters (Electronics, etc.)
  - Rating filters (4+ stars, 3+ stars)
  - Distance changes (5km → 10km)
  - Map/list view switching
  
  No additional backend calls needed
  unless user changes primary category
end note

@enduml
